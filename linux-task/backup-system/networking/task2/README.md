apt update
apt install openvswitch-switch
systemctl enable --now openvswitch-switch


–¢—ã —Å–æ–∑–¥–∞—ë—à—å –æ–¥–Ω—É —à–∏—Ä–æ–∫—É—é —Ç—Ä–∞—Å—Å—É (LACP)
–ò —Ä–∞–∑—Ä–µ—à–∞–µ—à—å –µ—Ö–∞—Ç—å –Ω–∞ –Ω–µ–π —Ä–∞–∑–Ω—ã–º —Ç–∏–ø–∞–º –º–∞—à–∏–Ω (VLAN).


LACP –∏ BOND ‚Äî —ç—Ç–æ –¥–≤–µ —á–∞—Å—Ç–∏ –æ–¥–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
BOND ‚Äî —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º –ª–∏–Ω–∫-–∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –≤ Linux.

–û–Ω –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ –≤ –æ–¥–∏–Ω –ª–æ–≥–∏—á–µ—Å–∫–∏–π.

LACP ‚Äî —ç—Ç–æ –ø—Ä–æ—Ç–æ–∫–æ–ª, –∫–æ—Ç–æ—Ä—ã–π BOND –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å.

–≠—Ç–æ –ø—Ä–æ—Ç–æ–∫–æ–ª —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è —Å—Ç–æ—Ä–æ–Ω–∞–º–∏, —á—Ç–æ –æ–Ω–∏ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ –æ–¥–∏–Ω –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–∞–Ω–∞–ª.



auto vmbr111
iface vmbr111 inet manual
    bridge-ports bond0.111
    bridge-stp off
    bridge-fd 0

auto vmbr112
iface vmbr112 inet manual
    bridge-ports bond0.112
    bridge-stp off
    bridge-fd 0

auto vmbr113
iface vmbr113 inet manual
    bridge-ports bond0.113
    bridge-stp off
    bridge-fd 0



–°—É–¥—è –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é –∏ —Ç–µ–∫—Å—Ç—É –ø–æ–¥ –Ω–∏–º, —ç—Ç–æ –∑–∞–¥–∞–Ω–∏–µ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ —Å–µ—Ç–µ–≤–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω–∞—Ö —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º LACP, VLAN –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏. –†–∞–∑–±–µ—Ä—ë–º, —á—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:

1Ô∏è‚É£ –û–±—â–∞—è —Ç–æ–ø–æ–ª–æ–≥–∏—è

4 –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã: a2-1, a2-2, a2-3, a2-4.

–ú–µ–∂–¥—É a2-1 –∏ a2-2 –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å LACP (Link Aggregation), –∫–æ—Ç–æ—Ä—ã–π –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã vmbr2121 –∏ vmbr2122.

–ù–∞ a2-2 –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –∫ a2-3 (vmbr223) –∏ –∫ a2-4 (vmbr224).

2Ô∏è‚É£ –°–µ—Ç–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

VLAN:

vlan1 (ID 111): 10.0.0.0/24

vlan2 (ID 112): 10.0.1.0/24

vlan3 (ID 113): 10.0.2.0/24

–ù–∞ –∫–∞–Ω–∞–ª–µ LACP –º–µ–∂–¥—É a2-1 –∏ a2-2 –¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å—Å—è –ø–æ —Ç—Ä—ë–º VLAN –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ: 111, 112, 113.

3Ô∏è‚É£ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ a2-2 –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ

–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –∫–æ—Ç–æ—Ä—ã–π –∏–¥—ë—Ç –∫ a2-4, –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–¥–∫–ª—é—á—ë–Ω —á–µ—Ä–µ–∑ bridge.

–° –ø–æ–º–æ—â—å—é netfilter (iptables –∏–ª–∏ nftables) –Ω—É–∂–Ω–æ –∏–º–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–∫–ª—é—á–∞—Ç—å/–æ—Ç–∫–ª—é—á–∞—Ç—å VLAN 111 –∏ 112 –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.

–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å LACP –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å IP –∏–∑ VLAN3 (10.0.2.x).

4Ô∏è‚É£ –¢—Ä–∞—Ñ–∏–∫

–ú–µ–∂–¥—É a2-2 –∏ a2-3 ‚Äî –±–µ–∑ VLAN, —Ç.–µ. —á–∏—Å—Ç—ã–π —Ç—Ä–∞—Ñ–∏–∫.

–ú–µ–∂–¥—É a2-2 –∏ a2-4 ‚Äî —Ç–æ–ª—å–∫–æ VLAN1 –∏ VLAN2, —Ç.–µ. —Ç—Ä–∞—Ñ–∏–∫ —ç—Ç–∏—Ö –¥–≤—É—Ö VLAN –¥–æ–ª–∂–µ–Ω –∏–¥—Ç–∏ –Ω–∞ a2-4.

5Ô∏è‚É£ –¶–µ–ª—å –∑–∞–¥–∞–Ω–∏—è

–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –¥–≤—É–º—è —Å–ø–æ—Å–æ–±–∞–º–∏:

–ß–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —Å–µ—Ç–µ–≤—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, /etc/network/interfaces –∏–ª–∏ netplan –Ω–∞ Linux VM).

–ß–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—ã –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ip link, ip addr, bridge, vconfig –∏ —Ç.–¥.).

–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω–∞—Ö.

üí° –ò—Ç–æ–≥:
–¢–µ–±–µ –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å LACP –º–µ–∂–¥—É a2-1 –∏ a2-2 —Å —Ç—Ä–µ–º—è VLAN, –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å bridge –Ω–∞ a2-2 –∫ a2-4 —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π VLAN, –≤—ã—Å—Ç–∞–≤–∏—Ç—å IP –Ω–∞ LACP –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏–∑ VLAN3, –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é –¥–≤—É–º—è —Å–ø–æ—Å–æ–±–∞–º–∏.

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, —è –º–æ–≥—É –Ω–∞–±—Ä–æ—Å–∞—Ç—å –ø–æ—à–∞–≥–æ–≤—É—é —Å—Ö–µ–º—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö –º–∞—à–∏–Ω —Å –∫–æ–º–∞–Ω–¥–∞–º–∏ Linux.
–•–æ—á–µ—à—å, —á—Ç–æ–±—ã —è —ç—Ç–æ —Å–¥–µ–ª–∞–ª?



                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                   ‚îÇ   a2-1      ‚îÇ
                   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
                   ‚îÇ vmbr2121    ‚îÇ
                   ‚îÇ vmbr2122    ‚îÇ
                   ‚îÇ bond0       ‚îÇ
                   ‚îÇ ‚îú‚îÄ bond0.111‚îÇ VLAN 111 (10.0.0.0/24)
                   ‚îÇ ‚îú‚îÄ bond0.112‚îÇ VLAN 112 (10.0.1.0/24)
                   ‚îÇ ‚îî‚îÄ bond0.113‚îÇ VLAN 113 (10.0.2.0/24)
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚îÇ  (LACP 802.3ad)
                         ‚îÇ
                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                   ‚îÇ  SW / vSwitch‚îÇ
                   ‚îÇ  –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç‚îÇ
                   ‚îÇ   LACP       ‚îÇ
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚îÇ  (LACP 802.3ad)
                         ‚îÇ
                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                   ‚îÇ   a2-2      ‚îÇ
                   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
                   ‚îÇ vmbr2121    ‚îÇ
                   ‚îÇ vmbr2122    ‚îÇ
                   ‚îÇ bond0       ‚îÇ
                   ‚îÇ ‚îú‚îÄ bond0.111‚îÇ VLAN 111 (–ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –Ω–∞ br224 ‚Üí a2-4)
                   ‚îÇ ‚îú‚îÄ bond0.112‚îÇ VLAN 112 (–ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –Ω–∞ br224 ‚Üí a2-4)
                   ‚îÇ ‚îî‚îÄ bond0.113‚îÇ VLAN 113 (IP 10.0.2.2, –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è)
                   ‚îÇ vmbr223     ‚îÇ –∫ a2-3 (–æ–±—ã—á–Ω—ã–π –ª–∏–Ω–∫)
                   ‚îÇ vmbr224     ‚îÇ –∫ a2-4 —á–µ—Ä–µ–∑ br224
                   ‚îÇ br224       ‚îÇ bridge –¥–ª—è VLAN111 –∏ VLAN112
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò


# /etc/netplan/01-a2-2.yaml
network:
  version: 2
  ethernets:
    ens18: {}
    ens19: {}
  bonds:
    bond0:
      interfaces: [ens18, ens19]
      parameters:
        mode: 802.3ad
        mii-monitor-interval: 100
        lacp-rate: fast
      dhcp4: no
  vlans:
    bond0.111:
      id: 111
      link: bond0
      addresses: [10.0.0.1/24]
    bond0.112:
      id: 112
      link: bond0
      addresses: [10.0.1.1/24]
    bond0.113:
      id: 113
      link: bond0
      addresses: [10.0.2.1/24]


–ú–∞—î–º–æ 4 –í–ú –∑‚Äô—î–¥–Ω–∞–Ω–∏—Ö –∑–≥—ñ–¥–Ω–æ —Ç–æ–ø–æ–ª–æ–≥—ñ—ó –≤–∏—â–µ. –ú—ñ–∂ a2-1 —ñ a2-2 –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ LACP, –ø–æ —è–∫–æ–º—É –±—É–¥—É—Ç—å –ø–µ—Ä–µ–¥–∞–≤–∞—Ç–∏—Å—å –¥–∞–Ω—ñ –ø–æ —Ç—Ä—å–æ—Ö –≤–ª–∞–Ω–∞—Ö (vlan1(111) vlan2(112) vlan3(113)).

–ù–∞ a2-2 –º—ñ–∂ LACP —Ç–∞ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º –≤ —Å—Ç–æ—Ä–æ–Ω—É a2-4 –º–∞—î –±—É—Ç–∏ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π bridge. –ù–∞ a2-2 –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é netfilter –ø–æ—Ç—Ä—ñ–±–Ω–æ –º–∞—Ç–∏ –∑–º–æ–≥—É –≤–º–∏–∫–∞—Ç–∏ –∞–±–æ –∑–∞–±–æ—Ä–æ–Ω—è—Ç–∏ vlan1, vlan2. –¢–∞–∫–æ–∂ –Ω–∞ a2-2 –Ω–∞ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ñ LACP –º–∞—î –±—É—Ç–∏ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∞ IP-–∞–¥—Ä–µ—Å–∞ –∑ vlan3.

–¢—Ä–∞—Ñ—ñ–∫ –º—ñ–∂ a2-2 —Ç–∞ a2-3 –º–∞—î –±—É—Ç–∏ –±–µ–∑ –≤–ª–∞–Ω—ñ–≤
–ú—ñ–∂ a2-2 —Ç–∞ a2-4 –º–∞—î –ø–µ—Ä–µ–¥–∞–≤–∞—Ç–∏—Å—å 2 –≤–ª–∞–Ω—ñ (vlan1, vlan2)

–í–∏ –º–∞—î—Ç–µ –ø—ñ–¥–≥–æ—Ç—É–≤–∞—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ä–æ—É—Ç–∏–Ω–≥—É –¥–≤–æ–º–∞ —Å–ø–æ—Å–æ–±–∞–º–∏ –∫–æ–Ω—Ñ—ñ–≥–æ–º (–º–∞—î –±—É—Ç–∏ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ –Ω–∞ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–∏—Ö –º–∞—à–∏–Ω–∞—Ö) —ñ –∫–æ–º–∞–Ω–¥–∞–º–∏ –∑ —Ç–µ—Ä–º—ñ–Ω–∞–ª—É (–º–∞—î –±—É—Ç–∏ –ø—ñ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ –æ–∫—Ä–µ–º–æ, –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏–º–µ—Ç—å—Å—è –ø—ñ–¥ —á–∞—Å –∑–¥–∞—á—ñ).




ovs-vsctl add-bond vmbr2121 bond0 tap108i0 tap108i2 lacp=active other-config:bond_mode=balance-slb

ovs-vsctl add-bond vmbr2122 bond1 tap108i1 tap109i1 lacp=active other-config:bond_mode=balance-slb

–µ—Å–ª–∏ –Ω–µ —Å—Ç–∞–µ—Ç –±–æ–Ω–¥ –¥–µ–ª–∞—Ç—å —Ä–µ–±—É—Ç

cat /proc/net/bonding/bond0 –∫–æ–Ω—Ñ–∏–≥ –±–æ–Ω–¥–∞









network:
  version: 2
  renderer: networkd
  ethernets:
    ens20:
      dhcp4: no
      addresses: [21.0.0.3/24]
    ens18: {}
    ens19: {}
    ens22: {}                    

  bonds:
    bond0:
      interfaces: [ens18, ens19]
      parameters:
        mode: active-backup
        primary: ens18
        mii-mon: 100

  bridges:
    br228:
      interfaces: [bond0, ens22]         # ‚Üê ens22 –∏ bond0 –≤ –æ–¥–Ω–æ–º –º–æ—Å—Ç—É
      dhcp4: no
      parameters:
        stp: false
        vlan-filtering: true             # ‚Üê –ö–†–ò–¢–ò–ß–ù–û! –±–µ–∑ —ç—Ç–æ–≥–æ VLAN –Ω–µ –≤—ã–π–¥–µ—Ç –Ω–∞—Ä—É–∂—É

  vlans:
    vlan103:
      id: 111
      link: bond0                        # ‚Üê vlan –Ω–∞ –º–æ—Å—Ç—É, –∞ –Ω–µ –Ω–∞ bond0
      addresses: [10.0.]



network:
  version: 2
  ethernets:
    ens18: {}
    ens19:
      dhcp4: no
      addresses:
        - 21.0.0.5/24
  vlans:
    vlan111:
      id: 111
      link: ens18
      addresses: [10.0.0.2/24]
